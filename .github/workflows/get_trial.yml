name: Collect List and Auto Update

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

permissions: write-all

jobs:
  collect-list:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      TZ: Asia/Shanghai
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DDAL_EMAIL: ${{ secrets.DDAL_EMAIL }}
      DDAL_PASSWORD: ${{ secrets.DDAL_PASSWORD }}
      REPO: ${{ secrets.REPO }}
      REPO_TOKEN: ${{ secrets.REPO_TOKEN }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: è¿è¡Œ list.py
        run: python list.py

      - name: Checkout remote repository
        id: checkout-remote
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REPO }}
          token: ${{ env.REPO_TOKEN }}
          path: temp-repo
          ref: main
          persist-credentials: true

      - name: Check checkout status
        if: steps.checkout-remote.outcome != 'success'
        run: |
          echo "âŒ Checkout remote repo failed. Skipping push trial.cfg."
          exit 0

      - name: Push trial.cfg to remote repo /file/
        if: steps.checkout-remote.outcome == 'success'
        run: |
          cd temp-repo
          mkdir -p file
          rm -f file/trial.cfg
          if [ -f ../trial.cfg ]; then
            cp ../trial.cfg file/
          fi

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
          git add file/trial.cfg
          if git diff --staged --quiet; then
            echo "No changes to trial.cfg, skipping commit."
          else
            git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(TZ='Asia/Shanghai' date +%Y-%m-%d" "%H:%M:%S)${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"
            git pull --rebase origin main
            git push origin main
            echo "âœ… trial.cfg å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“ /file/ã€‚"
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -rf temp-repo || true
          rm -f trial.cfg || true

  auto-update:
    runs-on: ubuntu-latest
    needs: collect-list
    timeout-minutes: 90
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      TZ: Asia/Shanghai
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DDAL_EMAIL: ${{ secrets.DDAL_EMAIL }}
      DDAL_PASSWORD: ${{ secrets.DDAL_PASSWORD }}
      REPO: ${{ secrets.REPO }}
      REPO_TOKEN: ${{ secrets.REPO_TOKEN }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 ruamel.yaml json5 pyyaml

      - name: Checkout remote repository
        id: checkout-remote
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REPO }}
          token: ${{ env.REPO_TOKEN }}
          path: temp-repo
          ref: main
          persist-credentials: true

      - name: Check checkout status
        if: steps.checkout-remote.outcome != 'success'
        run: |
          echo "âŒ Checkout remote repo failed. Skipping auto-update."
          exit 0

      - name: Copy trial.cfg from remote /file/ to working dir
        if: steps.checkout-remote.outcome == 'success'
        run: |
          if [ -f temp-repo/file/trial.cfg ]; then
            cp temp-repo/file/trial.cfg .
            echo "âœ… å·²ä»è¿œç¨‹ä»“åº“ /file/ æ‹‰å– trial.cfgã€‚"
          else
            echo "âŒ è¿œç¨‹ä»“åº“ /file/ æ—  trial.cfgï¼Œè·³è¿‡ get_trial.pyã€‚"
            exit 0
          fi

      - name: Run get_trial.py
        if: steps.checkout-remote.outcome == 'success'
        run: python get_trial.py --output-dir ./

      - name: Prepare success domains for push
        run: |
          ls -la success_domains* || echo "No success files found"

      - name: Push success domains to remote repo /file/
        if: steps.checkout-remote.outcome == 'success'
        run: |
          cd temp-repo
          mkdir -p file

          rm -f file/success_domains.txt
          if [ -f ../success_domains.txt ]; then
            cp ../success_domains.txt file/
          fi

          rm -f file/success_domains.json
          if [ -f ../success_domains.json ]; then
            cp ../success_domains.json file/
          fi

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
          git add file/
          if git diff --staged --quiet; then
            echo "No changes to success domains, skipping commit."
          else
            git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(TZ='Asia/Shanghai' date +%Y-%m-%d" "%H:%M:%S)${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"
            git pull --rebase origin main
            git push origin main
            echo "âœ… æˆåŠŸåŸŸåå·²æ¨é€åˆ°è¿œç¨‹ä»“åº“ /file/ã€‚"
          fi

      - name: Run get_trial_update_url.py (if needed)
        if: always()
        run: |
          if [ -f get_trial_update_url.py ]; then
            python get_trial_update_url.py
          else
            echo "get_trial_update_url.py not found, skipping."
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f trial.cfg success_domains.txt success_domains.json || true
          rm -rf temp-repo || true
